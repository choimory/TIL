# API의 멱등성(Idempotency)

- 멱등성은 API에서 동일한 요청을 여러 번 반복 실행해도 결과가 항상 동일하게 유지되는 특성.
- RESTful API 설계에서 중요한 개념으로, 클라이언트가 네트워크 문제로 요청을 재전송하거나, 시스템 내부에서 중복 요청이 발생해도 서버 상태에 부정적인 영향을 미치지 않도록 보장.

---

# 멱등성이 중요한 이유

## **중복 요청 처리**

- 네트워크 문제로 인해 클라이언트가 동일한 요청을 반복 실행할 경우에도 일관된 결과를 보장.

## **안전성**

- 여러 번 실행되더라도 동일한 상태를 유지하므로, 예측 가능한 동작을 제공.

## **확장성 및 신뢰성**

- 분산 시스템 및 API 게이트웨이와 같은 환경에서 요청의 중복을 허용하면서도 안정적으로 처리 가능.

## **클라이언트와 서버의 협업 향상**

- 클라이언트가 요청 성공 여부를 명확히 알지 못할 경우, 재시도 전략을 쉽게 설계할 수 있음.

---

# HTTP 메서드와 멱등성

## 1. **멱등성을 보장하는 메서드**

- **GET**
    - 자원을 조회하는 요청. 상태 변경이 없으며, 같은 요청을 반복해도 동일한 응답 반환.
    - 예: `GET /users/123`
- **PUT**
    - 자원을 전체 업데이트. 여러 번 실행해도 동일한 자원을 같은 상태로 유지.
    - 예: `PUT /users/123`요청 본문:

        ```json
        {
          "name": "John Doe",
          "email": "john.doe@example.com"
        }
        ```

- **DELETE**
    - 자원을 삭제. 동일한 요청이 반복되더라도 자원이 이미 삭제된 상태라면 결과는 동일.
    - 예: `DELETE /users/123`
- **HEAD**
    - 자원의 메타데이터를 조회. GET과 유사하며, 상태 변경이 없음.
- **OPTIONS**
    - 서버가 지원하는 메서드와 옵션을 조회. 상태 변경이 없음.

---

## 2. **멱등성을 보장하지 않는 메서드**

- **POST**
    - 새로운 자원을 생성하거나 특정 작업을 수행. 요청이 반복되면 동일한 데이터가 여러 번 생성될 수 있음.
    - 예: `POST /users`요청 본문:여러 번 호출 시 사용자 데이터가 중복 생성될 수 있음.

        ```json
        {
          "name": "John Doe",
          "email": "john.doe@example.com"
        }
        ```


---

# 멱등성을 보장하기 위한 구현 전략

## **클라이언트 제공 IDempotency Key 활용**

- 클라이언트가 요청 시 고유한 `Idempotency-Key`를 HTTP 헤더에 포함.
- 서버는 이 키를 사용해 동일한 요청인지 판단하고, 중복 요청을 차단하거나 같은 응답을 반환.
- 예:

    ```vbnet
    POST /payments
    Headers: Idempotency-Key: 12345-unique-key
    ```

- 서버는 이 키를 캐싱 또는 데이터베이스에 저장하여 중복 요청 여부 확인.

## **PUT과 DELETE를 선호**

- POST 대신 PUT을 사용해 특정 자원의 상태를 설정.
- DELETE 요청은 동일한 요청이 반복되더라도 결과가 일관되도록 처리.

## **요청의 불변 데이터 구조 설계**

- 요청 데이터를 설계할 때, 같은 데이터로 요청하면 항상 동일한 결과를 반환하도록 구현.
- 예: 동일한 자원을 수정하거나 삭제하는 요청에서 결과가 변하지 않도록 상태를 관리.

## **조건부 요청 활용 (Conditional Requests)**

- HTTP 헤더 `If-Match` 또는 `If-None-Match`를 사용해 특정 조건이 충족될 때만 작업을 수행.
- 예: `PUT` 요청 시 ETag 값을 기반으로 조건부 업데이트.

---

# RESTful API에서 멱등성의 예

## **1. GET**

- 요청:

    ```bash
    GET /users/123
    ```

- 결과:서버 상태에 영향을 주지 않으며, 동일한 응답 반환.

## **2. PUT**

- 요청:

    ```json
    PUT /users/123
    Body:
    {
      "name": "Jane Doe",
      "email": "jane.doe@example.com"
    }
    ```

- 결과:자원을 업데이트. 동일 요청 반복 시 상태 변화 없음.

## **3. DELETE**

- 요청:

    ```bash
    DELETE /users/123
    ```

- 결과:자원 삭제. 이미 삭제된 자원에 동일 요청을 보내도 결과는 동일.

---

# 장점

- 클라이언트의 요청 재전송에 대한 신뢰성 확보.
- 네트워크 오류나 분산 환경에서 일관된 결과 제공.
- API 사용자의 디버깅과 유지보수 용이.

# 단점

- 멱등성을 구현하기 위한 추가적인 로직(중복 요청 관리 등) 필요.
- 일부 복잡한 작업에서는 멱등성 구현이 어려울 수 있음.

---

# **요약**

- 멱등성은 동일한 요청을 반복해도 서버 상태와 결과가 변하지 않는 API의 속성으로, RESTful 설계에서 안정성과 신뢰성을 보장하는 핵심 요소.
- 주로 GET, PUT, DELETE에서 멱등성을 보장하며, POST의 경우 Idempotency-Key와 같은 전략을 통해 보완 가능.
- 안정적이고 예측 가능한 API를 설계하기 위한 필수 개념.