# JPA의 캐시전략(1차 캐시, 2차 캐시)에 대해

- **1차 캐시**: 트랜잭션 내에서만 유효하며, 영속성 컨텍스트에서 엔티티 매니저가 관리하는 **캐시**. 동일한 엔티티를 중복 조회할 때 쿼리를 방지하고, 성능을 최적화.
- **2차 캐시**: **애플리케이션 전체에서 공유되는 캐시**로, 여러 트랜잭션에서 동일한 데이터를 조회할 때 캐시된 데이터를 재사용하여 **데이터베이스 접근을 최소화**.
- 1차 캐시는 JPA가 기본적으로 제공하고 있으며, 모든 트랜잭션 내에서 자동으로 사용됨.
- 2차 캐시는 애플리케이션의 요구 사항에 따라 선택적으로 사용할 수 있으며, 별도의 설정이 필요.
- 2차 캐시는 데이터베이스에 대한 접근을 줄여 성능을 크게 향상시킬 수 있음.

# 1차 캐시

- **1차 캐시**는 **영속성 컨텍스트(Persistence Context)** 내부에서 관리되며, 각 **트랜잭션 단위**로 적용되는 캐시.
- 엔티티 매니저가 관리하는 특정 트랜잭션 내에서 동일한 엔티티를 다시 조회할 경우, 데이터베이스를 다시 조회하지 않고, 영속성 컨텍스트에 저장된 엔티티를 재사용함.
- 엔티티 매니저(EntityManager가 관리하는 **세션** 동안만 유효함.
- **동작 방식**:
    - 한 번 조회한 엔티티는 **1차 캐시**에 저장되어 트랜잭션이 끝날 때까지 재사용됨.
    - 트랜잭션 내에서 동일한 엔티티를 여러 번 조회하면, 첫 번째 조회 시점에 데이터베이스에서 가져온 후 이후에는 **캐시에서 반환**.
    - 트랜잭션이 끝나면 1차 캐시도 사라짐.

## **장점**:

### **중복 쿼리 방지**:

- 동일한 엔티티를 여러 번 조회하더라도 중복 쿼리가 발생하지 않음.

### **변경 감지**:

- 엔티티의 변경 사항을 영속성 컨텍스트에서 자동으로 감지하여 트랜잭션이 커밋될 때 자동으로 데이터베이스에 반영.

### **성능 최적화**:

- 데이터베이스에 직접 쿼리를 날리는 대신 캐시에 저장된 엔티티를 사용하므로 성능이 최적화됨.
- 예시:

    ```java
    EntityManager em = ...;
    
    User user1 = em.find(User.class, 1L);  // DB 조회
    User user2 = em.find(User.class, 1L);  // 1차 캐시에서 조회, DB 조회 안 함
    ```

    - `user1`을 데이터베이스에서 조회한 후, 같은 트랜잭션 내에서 동일한 엔티티 `user2`를 다시 조회하면 데이터베이스에 쿼리가 실행되지 않고 **1차 캐시**에서 값을 반환.

# 2차 캐시

- **2차 캐시**는 **영속성 컨텍스트 밖에서 사용되는 전역 캐시**로, **애플리케이션 전체**에서 공유됨.
- 1차 캐시와 달리 **엔티티 매니저의 생명주기**와 상관없이 **데이터베이스에 대한 재조회 횟수를 줄이기 위해** 사용됨.
- **설명**: 2차 캐시는 **애플리케이션 전반에서 공유**되는 캐시로, 영속성 컨텍스트가 종료된 이후에도 캐시된 데이터를 재사용할 수 있음.
- 이를 통해 애플리케이션이 종료되지 않는 한, 데이터베이스 접근을 최소화하여 성능을 최적화함.

## **동작 방식**:

- JPA는 **2차 캐시 제공자**(예: **EHCache**, **Infinispan** 등)와 함께 사용하여 엔티티를 **영속성 컨텍스트 밖에 캐시**할 수 있음.
- 데이터베이스에서 한 번 조회된 엔티티는 2차 캐시에 저장되어, 이후 같은 엔티티를 조회할 때 **데이터베이스에 접근하지 않고** 캐시에서 반환됨.
- 여러 영속성 컨텍스트가 캐시된 데이터를 공유 가능.

## **장점:**

### **DB 부하 감소**:

- 엔티티 매니저가 종료된 후에도 캐시된 데이터를 재사용하여 데이터베이스 쿼리 발생을 줄일 수 있음.

### **애플리케이션 전체 캐싱**:

- 2차 캐시가 활성화되면 여러 트랜잭션 또는 여러 사용자가 동일한 엔티티를 조회할 때 캐시된 데이터를 재사용 가능.

### **성능 향상**:

- 데이터베이스 접근이 빈번한 애플리케이션에서 캐싱을 통해 성능을 크게 향상시킬 수 있음.

## **설정**

- 2차 캐시는 JPA가 기본적으로 제공하지 않으며, **별도의 캐시 제공자**를 설정해야 함. 예를 들어, **Hibernate**를 사용하는 경우 EHCache와 같은 캐시를 설정할 수 있음.
- **예시 (Hibernate와 EHCache 사용)**
    - **persistence.xml 설정**:

        ```xml
        <property name="hibernate.cache.use_second_level_cache" value="true"/>
        <property name="hibernate.cache.region.factory_class" value="org.hibernate.cache.ehcache.EhCacheRegionFactory"/>
        <property name="hibernate.cache.use_query_cache" value="true"/>
        ```

    - **엔티티 클래스에서 2차 캐시 설정**:

        ```java
        @Entity
        @Cacheable  // 2차 캐시 사용 설정
        @org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
        public class User {
            @Id
            @GeneratedValue(strategy = GenerationType.IDENTITY)
            private Long id;
        
            private String name;
        }
        ```


# 비교

| **특징** | **1차 캐시** | **2차 캐시** |
| --- | --- | --- |
| **캐시 범위** | 영속성 컨텍스트(EntityManager) 범위 | 애플리케이션 전체에서 공유 (엔티티 매니저 종료 후에도 사용 가능) |
| **캐시 수명** | 트랜잭션이 끝날 때까지만 유효 | 애플리케이션이 종료될 때까지 유효 |
| **기본 제공 여부** | JPA에서 기본 제공 | 별도의 캐시 제공자 설정 필요 |
| **사용 목적** | 같은 트랜잭션 내에서 중복된 DB 쿼리 방지 | 애플리케이션 전역에서 DB 접근 최소화 |
| **캐시 대상** | 특정 트랜잭션 범위 내에서 조회된 엔티티 | 영속성 컨텍스트 종료 후에도 캐싱된 엔티티 |